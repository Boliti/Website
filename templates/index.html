<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Спектральный анализ</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://cdn.plot.ly/plotly-2.14.0.min.js"></script>
    <script defer src="/static/app.js"></script>
</head>
<body>

<h1>Обработка спектров</h1>
<div class="main-content">
    <div class="controls">
        <!-- Upload Section -->
        <div class="control-card">
            <h3 class="control-title">Управление файлами</h3>
            <div class="upload-section">
                <div class="file-input-container">
                    <label for="files" class="file-input-label">
                        <span class="file-input-text">Выбрать файлы</span>
                    </label>
                    <input type="file" id="files" multiple title="Загрузите файлы для анализа">
                </div>
                <div class="upload-buttons">
                    <button onclick="uploadFiles()" class="btn-primary" title="Загрузить выбранные файлы">
                        Загрузить
                    </button>
                    <button onclick="addMoreFiles()" class="btn-secondary" title="Добавить файлы к текущим">
                        Добавить
                    </button>
                </div>
                <div id="file-count" class="file-count">Не выбран ни один файл</div>
            </div>
        </div>

        <!-- Parameters Sections -->
        <div class="control-card">
            <h3 class="control-title">Параметры обработки</h3>
            
            <!-- Frequency Range -->
            <div class="parameter-group">
                <h4 class="parameter-title">Диапазон частот</h4>
                <div class="input-group">
                    <label for="min_freq" class="input-label">Минимальная частота:</label>
                    <input type="number" id="min_freq" class="input-field" step="10" placeholder="0" title="Минимальная частота для анализа">
                </div>
                <div class="input-group">
                    <label for="max_freq" class="input-label">Максимальная частота:</label>
                    <input type="number" id="max_freq" class="input-field" step="10" placeholder="10000" title="Максимальная частота для анализа">
                </div>
            </div>

            <!-- Baseline Removal -->
            <div class="parameter-group">
                <h4 class="parameter-title">Базовая линия
                    <span class="help-icon" data-tooltip="Метод ALS минимизирует разницу между исходными данными и сглаженной базовой линией, учитывая асимметричность ошибок. Это позволяет сохранить полезный сигнал, удаляя низкочастотную базовую линию.">?</span>
                </h4>
                <div class="checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="remove_baseline" class="checkbox-input" title="Удалить базовую линию с использованием метода BL_ALS">
                        Метод BL_ALS
                    </label>
                </div>
                <div class="input-row">
                    <div class="input-group compact">
                        <label for="lam" class="input-label">lam:</label>
                        <input type="number" id="lam" class="input-field small" step="100" placeholder="1000" title="Параметр регуляризации для метода BL_ALS">
                    </div>
                    <div class="input-group compact">
                        <label for="p" class="input-label">p:</label>
                        <input type="number" id="p" class="input-field small" step="0.01" placeholder="0.001" title="Весовые коэффициенты для метода BL_ALS">
                    </div>
                </div>
            </div>

            <!-- Normalization -->
            <div class="parameter-group">
                <h4 class="parameter-title">Нормировка
                    <span class="help-icon" data-tooltip="Нормировка SNV преобразует данные так, чтобы каждый спектр имел среднее значение, равное нулю, и стандартное отклонение, равное единице. Это устраняет смещение и масштабирует данные для сравнения.">?</span>
                </h4>
                <div class="checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="normalize" class="checkbox-input" title="Нормализация методом SNV">
                        Метод SNV
                    </label>
                </div>
            </div>

            <!-- Smoothing -->
            <div class="parameter-group">
                <h4 class="parameter-title">Сглаживание
                    <span class="help-icon" data-tooltip="Фильтр Савицкого-Голая: локальная аппроксимация сигнала полиномом в скользящем окне. Разбивает сигнал на небольшие участки и заменяет значения в центре окна на вычисленные по полиному.">?</span>
                </h4>
                <div class="checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="apply_smoothing" class="checkbox-input" title="Применить фильтр Савицкого-Голая">
                        Фильтр Савицкого-Голая
                    </label>
                </div>
                <div class="input-row">
                    <div class="input-group compact">
                        <label for="window_length" class="input-label">Размер окна:</label>
                        <input type="number" id="window_length" class="input-field small" step="1" placeholder="25" title="Длина окна для фильтра Савицкого-Голая">
                    </div>
                    <div class="input-group compact">
                        <label for="polyorder" class="input-label">Полином:</label>
                        <input type="number" id="polyorder" class="input-field small" step="1" placeholder="1" title="Порядок полинома для фильтра Савицкого-Голая">
                    </div>
                </div>
            </div>

            <!-- Moving Average -->
            <div class="parameter-group">
                <h4 class="parameter-title">Скользящее среднее
                    <span class="help-icon" data-tooltip="Расчет скользящего среднего для сглаживания данных. Укажите размер окна для усреднения.">?</span>
                </h4>
                <div class="checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="show_moving_average" class="checkbox-input" title="Показать скользящую среднюю">
                        Включить
                    </label>
                </div>
                <div class="input-group">
                    <label for="moving_average_window" class="input-label">Размер окна:</label>
                    <input type="number" id="moving_average_window" class="input-field" step="1" placeholder="10" title="Размер окна для скользящего среднего">
                </div>
            </div>

            <!-- Statistics -->
            <div class="parameter-group">
                <h4 class="parameter-title">Статистика
                    <span class="help-icon" data-tooltip="Вычисляет среднее значение и стандартное отклонение по всем загруженным и обработанным спектрам для статистического анализа.">?</span>
                </h4>
                <div class="checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="calculate_mean_std" class="checkbox-input" title="Рассчитать среднее и стандартное отклонение">
                        Среднее и СКО
                    </label>
                </div>
                <div class="checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="calculate_boxplot" class="checkbox-input" title="Построить ящики с усами">
                        Box plot
                    </label>
                </div>
            </div>

            <!-- Peak Detection -->
            <div class="parameter-group">
                <h4 class="parameter-title">Поиск пиков
                    <span class="help-icon" data-tooltip="Автоматическое обнаружение пиков в спектрах с настраиваемыми параметрами ширины и значимости пиков.">?</span>
                </h4>
                <div class="checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="find_peaks" class="checkbox-input" title="Поиск пиков в спектре">
                        Включить поиск
                    </label>
                </div>
                <div class="input-row">
                    <div class="input-group compact">
                        <label for="peak_width" class="input-label">Width:</label>
                        <input type="number" id="peak_width" class="input-field small" step="10" placeholder="10" title="Ширина пиков">
                    </div>
                    <div class="input-group compact">
                        <label for="peak_prominence" class="input-label">Prominence:</label>
                        <input type="number" id="peak_prominence" class="input-field small" step="1" placeholder="1" title="Значимость пиков">
                    </div>
                </div>
                <div class="checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="show_peak_table" class="checkbox-input" title="Отобразить таблицу пиков">
                        Показать таблицу
                    </label>
                </div>
            </div>

            <!-- Display Options -->
            <div class="parameter-group">
                <h4 class="parameter-title">Отображение
                    <span class="help-icon" data-tooltip="Управление отображением графиков: показывать все спектры или только статистические данные (среднее и стандартное отклонение).">?</span>
                </h4>
                <div class="checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="show_only_mean_std" class="checkbox-input" title="Отображать только среднее и СКО">
                        Только статистика
                    </label>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="control-card">
            <h3 class="control-title">Действия</h3>
            <div class="action-buttons">
                <button onclick="processAndPlot()" class="btn-action process-btn" title="Обработать данные и построить график">
                    Обработать данные
                </button>
                <button onclick="downloadMeanSpectrum()" class="btn-action download-btn" title="Скачать средний спектр">
                    Скачать среднее
                </button>
                <button onclick="downloadProcessedData()" class="btn-action download-btn" title="Скачать обработанные данные">
                    Скачать все
                </button>
                <button onclick="clearAllSpectra()" class="btn-action clear-btn" title="Очистить все спектры">
                    Очистить все
                </button>
            </div>
        </div>
    </div>
    
    <div class="plot-area">
        <div id="spectrum_plot"></div>
        <div id="peak_table_container"></div>
    </div>
</div>

<button id="theme-toggle" title="Переключить тему оформления">Тема</button>

</body>
</html>